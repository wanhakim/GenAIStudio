- name: Install local-path-provisioner
  hosts: localhost
  vars_files:
    - ../vars.yml
  tasks:

    - name: Check if local-path-storage namespace exists
      shell: kubectl get namespace local-path-storage --ignore-not-found
      register: namespace_check
      ignore_errors: yes
      changed_when: false
    
    - name: Install local-path-provisioner if namespace does not exist
      shell: kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
      when: namespace_check.stdout == ""
      register: apply_output
      environment:
        http_proxy: "{{ http_proxy }}"
        https_proxy: "{{ http_proxy }}"
        no_proxy: "{{ no_proxy }}"

    - name: Wait for local-path-provisioner to be ready
      shell: kubectl wait --for=condition=Ready pod -l app=local-path-provisioner -n local-path-storage --timeout=120s
      when: namespace_check.stdout == ""

    - name: Install Helm locally if not already installed
      shell: |
        if ! command -v helm >/dev/null 2>&1; then
          set -e
          HELM_VERSION=$(curl -s https://api.github.com/repos/helm/helm/releases/latest | grep tag_name | cut -d '"' -f 4)
          wget -q https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz -O /tmp/helm.tar.gz
          tar -zxvf /tmp/helm.tar.gz -C /tmp
          mv /tmp/linux-amd64/helm /usr/local/bin/helm
        fi
      args:
        executable: /bin/bash
      environment:
        http_proxy: "{{ http_proxy }}"
        https_proxy: "{{ http_proxy }}"